# 期权交易分析工具集

这是一个用于分析期权交易的综合工具集，包含基础期权分析和 Roll Position 分析功能。支持 sell call 和 sell put 期权的详细分析，帮助投资者更好地理解期权交易的风险和收益。

## ✨ 功能特点

### 1. 基础期权分析 (`basic_analyzer.py`)
- **行权利润计算**：如果到期被行权，计算利润（考虑期权费和执行价与成本的差额）
- **利润百分比**：行权利润 ÷ 持仓总金额 × 100%
- **盈亏平衡价格**：
  - 亏损平衡价：股价跌到多少开始亏损
  - 盈利平衡价：股价涨到多少开始无利润（针对sell call）

### 2. Roll Position 分析 (`roll_analyzer.py`)
- **旧期权费收入计算**：基于原始期权价格和合同数量
- **新期权费收入计算**：基于新的期权价格和合同数量  
- **Roll 后利润变化**：期权费变化 + 执行价变化影响
- **盈亏平衡价格更新**：计算新的盈利/亏损平衡点
- **批量处理和可视化**：支持多期权 roll 分析

## 🚀 快速开始

### 安装依赖
```bash
pip install -r requirements.txt
```

### 准备数据
1. **基础期权分析**：准备包含 7 列的 CSV 文件（见下方模板）
2. **Roll 分析**：准备包含 9 列的 CSV 文件（见下方模板）

### 运行分析
```bash
# 基础期权分析
python basic_analyzer.py --input 您的数据.csv --plot

# Roll Position 分析
python roll_analyzer.py --input 您的roll数据.csv --plot

# 创建示例数据文件
python basic_analyzer.py --create-sample
python roll_analyzer.py --create-sample
```

## 📋 输入数据格式

### 基础期权分析 CSV 模板
CSV文件必须包含以下列（列名必须完全匹配）：

| 列名 | 说明 | 示例 | 注意事项 |
|------|------|------|----------|
| 股票代码 | 股票代码 | AAPL, TSLA | 任意文本 |
| 期权类型 | sell call 或 sell put | sell call | 必须为 "sell call" 或 "sell put" |
| 执行日 | 期权到期日 | 2024-03-15 | 日期格式 YYYY-MM-DD |
| 执行价 | 期权执行价格 | 180.00 | 数字格式 |
| 期权价格 | 每股期权费 | 5.00 | **重要：输入每股期权费，不是每份合同总费用** |
| 每股均价 | 持仓成本价 | 175.00 | 数字格式 |
| 合同数量 | 期权合同份数 | 1 | 整数，每份合同对应100股 |

### Roll 分析 CSV 模板
在基础格式基础上，需要额外添加：

| 列名 | 说明 | 示例 |
|------|------|------|
| 新的期权价格 | 新期权的每股期权费 | 6.5 |
| 新的执行价格 | 新期权的执行价格 | 185 |
| 平仓价格 | 平掉旧仓位的每股价格 | 2.0 |

## 📊 输出结果

### 基础期权分析输出
1. **详细分析结果**：每笔期权交易的详细计算
2. **股票汇总结果**：按股票代码汇总的总利润和盈亏平衡点
3. **可视化图表**：各股票的盈亏平衡情况

### Roll 分析输出
1. **详细分析结果**：每笔 roll 交易的详细计算
2. **汇总分析结果**：按股票汇总的 roll 分析
3. **可视化图表**：
   - Roll 前后期权费收入对比
   - Roll 后利润变化柱状图
   - 盈亏平衡价格变化对比
   - 利润变化百分比分析

## 🧮 计算逻辑说明

### 基础期权分析
#### Sell Call 期权
- **行权利润** = 期权费 + (执行价 - 成本价) × 100股
- **盈利平衡价** = 执行价 + 每股期权费
- **亏损平衡价** = 成本价 - 每股期权费

#### Sell Put 期权
- **行权利润** = 期权费 - (成本价 - 执行价) × 100股
- **盈利平衡价** = 执行价 - 每股期权费
- **亏损平衡价** = 成本价 + 每股期权费

### Roll 分析
#### Sell Call Roll
- **期权费变化** = 新期权费 - 旧期权费
- **执行价影响** = (新执行价 - 旧执行价) × 100股 × 合同数量
- **总利润变化** = 期权费变化 + 执行价影响

#### Sell Put Roll
- **期权费变化** = 新期权费 - 旧期权费
- **执行价影响** = (旧执行价 - 新执行价) × 100股 × 合同数量
- **总利润变化** = 期权费变化 + 执行价影响

## 💻 命令行参数

### 基础期权分析
```bash
python basic_analyzer.py --input 数据文件.csv --plot --format excel
```

### Roll 分析
```bash
python roll_analyzer.py --input roll数据文件.csv --plot --format excel
```

| 参数 | 简写 | 说明 | 示例 |
|------|------|------|------|
| --input | -i | 输入文件路径（CSV或Excel） | --input data.csv |
| --output | -o | 输出文件名前缀 | --output 我的分析 |
| --format | -f | 输出格式（csv或excel） | --format excel |
| --plot | -p | 生成图表 | --plot |
| --create-sample | -s | 创建示例数据文件 | --create-sample |

## 📈 输入数据模板

### 基础期权分析 CSV 模板
```csv
股票代码,期权类型,执行日,执行价,期权价格,每股均价,合同数量
AAPL,sell call,2024-03-15,180,5.00,175,1
AAPL,sell put,2024-03-15,160,3.00,175,1
TSLA,sell call,2024-04-19,250,8.00,240,2
TSLA,sell put,2024-04-19,220,6.00,240,1
MSFT,sell call,2024-05-17,400,12.00,380,1
```

### Roll 分析 CSV 模板
```csv
股票代码,期权类型,执行日,执行价,期权价格,每股均价,合同数量,新的期权价格,新的执行价格,平仓价格
AAPL,sell call,2024-03-15,180,5.0,175,1,6.5,185,2.0
AAPL,sell put,2024-03-15,160,3.0,175,1,2.5,155,1.5
TSLA,sell call,2024-04-19,250,8.0,240,2,9.0,260,3.0
TSLA,sell put,2024-04-19,220,6.0,240,1,5.5,215,2.5
MSFT,sell call,2024-05-17,400,12.0,380,1,13.5,410,4.0
```

## 📁 输出文件

分析完成后，会在 `output/` 目录下生成带时间戳的子目录，包含：
- `期权分析结果_详细.csv`：每笔交易的详细分析
- `期权分析结果_汇总.csv`：按股票汇总的结果
- `期权分析图表.png`：可视化图表（如果使用 --plot 参数）

## ⚠️ 注意事项

1. **期权价格输入**：输入每股期权费，不是每份合同的总费用
2. **数据格式**：确保数值字段只包含数字，日期格式为 YYYY-MM-DD
3. **期权类型**：必须为 "sell call" 或 "sell put"
4. **合同数量**：必须为正整数，每份合同对应100股
5. **文件编码**：建议使用UTF-8编码的CSV文件

## 🔧 故障排除

### 常见错误
1. **缺少必需的列**：检查CSV文件是否包含所有必需的列
2. **数据类型错误**：确保数值字段只包含数字
3. **期权类型错误**：确保期权类型为 "sell call" 或 "sell put"
4. **图表显示问题**：如果图表中文显示异常，可能需要安装中文字体
5. **文件路径错误**：确保输入文件路径正确

### 获取帮助
```bash
python basic_analyzer.py --help
python roll_analyzer.py --help
```

## 📦 依赖包

- pandas>=1.3.0：数据处理
- numpy>=1.21.0：数值计算
- matplotlib>=3.5.0：图表绘制
- seaborn>=0.11.0：统计图表
- openpyxl>=3.0.0：Excel文件支持

## 🛠️ 工具文件

- `basic_analyzer.py`：基础期权分析工具
- `roll_analyzer.py`：期权 Roll Position 分析工具
- `示例期权数据.csv`：基础期权分析示例数据
- `示例期权Roll数据.csv`：Roll 分析示例数据 